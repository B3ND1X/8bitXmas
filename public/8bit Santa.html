<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>8bit Santa</title>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1e36" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(180deg, #061221 0%, #0b2544 60%, #08192f 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overscroll-behavior: contain;
      touch-action: none;              /* prevent scroll/zoom gestures */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
      font-size: 16px;
    }

    /* Use dynamic viewport height on modern mobile browsers */
    body {
      height: 100vh;
    }
    @supports (height: 100dvh) {
      body {
        height: 100dvh;
      }
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      margin: 0 auto;
      max-width: 900px;
      overflow: hidden; /* no scroll */

      padding-left: env(safe-area-inset-left, 0);
      padding-right: env(safe-area-inset-right, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);

      background: linear-gradient(180deg, #0b1e36 0%,
        #123c6a 55%, #0b233f 100%);
      box-shadow: 0 18px 42px rgba(0,0,0,0.45);
    }

    /* Top ~60% = game screen */
    .screen {
      flex: 0 0 60%;
      background: #000;
      position: relative;
    }

    .screen iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 18px 18px 0 0;
      background: #000;
    }

    /* Bottom ~40% = controller background */
    .controller-wrapper {
      flex: 1 1 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 0 8px;
      background: linear-gradient(180deg,
        rgba(255, 255, 255, 0.05),
        rgba(255, 255, 255, 0.02)), #0c1e33;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .controller {
      position: relative;
      width: 100%;
      max-width: 900px;

      /* match image aspect so it isn’t squished */
      aspect-ratio: 1170 / 949;

      background-image: url("controller-bg.jpg");
      background-repeat: no-repeat;
      background-size: contain;   /* show full pad */
      background-position: center;

      touch-action: none;
      user-select: none;
    }

    .button-zone {
      position: absolute;
      background: transparent;        /* use rgba(...) to debug if needed */
      touch-action: none;
      user-select: none;
    }

    /* ---- Hitboxes (tuned for the single-pad image) ---- */

 /* D-pad left: move further left + larger tap box */
.btn-left {
  left: 10%;    /* was 14% */
  top: 34%;     /* tiny nudge up so it hugs D-pad */
  width: 15%;   /* was 11%  → bigger */
  height: 32%;  /* was 30%  → slightly taller */
}

/* D-pad right: same x, just a bit wider */
.btn-right {
  left: 26%;    /* was 25% – tiny nudge right to increase spacing */
  top: 34%;     /* match left */
  width: 15%;   /* was 11% */
  height: 32%;
}

/* Jump: left half of the yellow B button */
/* Red A / B jump button – slightly right + bigger tap zone */
.btn-a {
  left: 74%;     /* was 73% – nudged a bit to the right */
  top: 33%;      /* same vertical position */
  width: 18%;    /* was 17% – wider hit area */
  height: 28%;   /* was 26% – a little taller */
  border-radius: 50%;
}


    /* small title overlay at very top of the wrapper */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #ffde59;
      text-align: center;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .screen iframe {
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="screen">
      <iframe id="game-frame" src="game.html" title="8bit Santa"></iframe>
    </div>

    <div class="controller-wrapper">
      <div class="controller">
        <div class="button-zone btn-left"  data-action="left"></div>
        <div class="button-zone btn-right" data-action="right"></div>
        <div class="button-zone btn-a"     data-action="jump"></div>
      </div>
    </div>
  </div>

  <script>
    /* Block double-tap / pinch zoom on iOS */
    let lastTouchEnd = 0;
    document.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTouchEnd < 500) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
    document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive: false });
    const stopZoom = (e) => {
      if (e.touches && e.touches.length > 1) e.preventDefault();
    };
    document.addEventListener("touchstart", stopZoom, { passive: false });
    document.addEventListener("touchmove", stopZoom, { passive: false });
    document.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
    document.addEventListener("dblclick", (e) => e.preventDefault(), { passive: false });

    const frame = document.getElementById("game-frame");

    function sendAction(type, action) {
      frame.contentWindow?.postMessage(
        { type, action, source: "controller" },
        "*"
      );
    }

    function wireButton(el) {
      const action = el.dataset.action;
      if (!action) return;

      const down = () => sendAction("down", action);
      const up   = () => sendAction("up", action);

      el.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        el.setPointerCapture(e.pointerId);
        down();
      });

      el.addEventListener("pointerup", (e) => {
        e.preventDefault();
        up();
      });

      el.addEventListener("pointercancel", up);
      el.addEventListener("pointerleave", up);
    }

    document.querySelectorAll(".button-zone").forEach(wireButton);

    /* Keyboard for desktop testing */
    window.addEventListener("keydown", (e) => {
      if (e.repeat) return;
      if (e.key === "ArrowLeft")  sendAction("down", "left");
      if (e.key === "ArrowRight") sendAction("down", "right");
      if (e.key === " " || e.key === "z" || e.key === "Z")
        sendAction("down", "jump");
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft")  sendAction("up", "left");
      if (e.key === "ArrowRight") sendAction("up", "right");
      if (e.key === " " || e.key === "z" || e.key === "Z")
        sendAction("up", "jump");
    });

    const warmCache = () =>
      navigator.serviceWorker.ready
        .then((registration) => registration.active?.postMessage({ type: "WARM_CACHE" }))
        .catch(() => {});

    const registerServiceWorker = () => {
      navigator.serviceWorker
        .register("./sw.js")
        .then(warmCache)
        .catch(() => {});
    };

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", registerServiceWorker);
    }
  </script>
</body>
</html>
